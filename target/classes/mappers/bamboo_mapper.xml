<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.harang.mapper.bamboo-mapper">
  
  	<select id = "bbList" parameterType="SearchCriteria" resultType="Bamboo">
  	
  		select distinct bb.bb_num, bb.m_id, bb_notice, bb_title, bb_content, bb_regdate, bb_count, bb_nickname,
  		 ifnull(like_cnt,0), (select count(br_num) from tbl_bbreply where bb_num = bb.bb_num) as bb_replycnt from tbl_bamboo bb left outer join
  		  (select bb_num, count(tbl_like.m_id) like_cnt from tbl_like group by bb_num) li on bb.bb_num = li.bb_num where
  		  <include refid="search"></include>
  		  limit #{pageStart}, #{perPageNum} 
  		  
  		  
  		  
  	
  	</select>
  	
  	<select id = "bbListCount" parameterType="SearchCriteria" resultType = "int">
  	
  		select count(bb_num) from tbl_bamboo where 
  		<include refid="search"></include> 
  	
  	</select>
  	
  	<sql id="search">
  		<if test="keyword == null">
  		   bb_notice = 'N' order by bb_regdate desc
  		</if>  
  		<if test="keyword != null">
  			<if test="keyword == 'bbnewlist'.toString()">
  				bb_regdate > (select date_sub(now(), interval 3 day)) and bb_notice='N' order by bb_regdate desc 
  			</if>
  		
  			<if test="keyword == 'bbhotlist'.toString()">
  				 bb_regdate> (select date_sub(now(), interval 30 day)) and bb_notice='N' order by like_cnt desc, bb.bb_count 
  			</if>
  		
  			<if test="keyfield == 'bb_title'.toString()">
  				bb_title like concat('%', #{keyword}, '%') and bb_notice='N' order by bb_regdate desc
  			</if>
  			
  			<if test="keyfield == 'bb_content'.toString()">
				bb_content like concat('%', #{keyword}, '%') and bb_notice='N' order by bb_regdate desc
  			</if>
  		
  		
  		</if> 
  		   
  	</sql>
  	
  	<select id = "bbNList" resultType = "Bamboo">
  	
  		select distinct bb.bb_num, bb.m_id, bb_notice, bb_title, bb_content, bb_regdate, bb_count, bb_nickname,
  		 ifnull(like_cnt,0), (select count(br_num) from tbl_bbreply where bb_num = bb.bb_num) as bb_replycnt 
  		 from tbl_bamboo bb left outer join (select bb_num, count(tbl_like.m_id) like_cnt from tbl_like group by bb_num) 
  		 li on bb.bb_num = li.bb_num where bb_notice = 'Y' order by bb_regdate desc  
  		
  	</select>
  	
  	<select id = "bbCon" parameterType = "String" resultType = "Bamboo">
  	
  		select * from tbl_bamboo where bb_num = #{bb_num}
  	
  	</select>
  	
  	<select id = "bbLCnt" parameterType="String" resultType = "Like">
  		SELECT * FROM harang.tbl_like where bb_num = #{bb_num}
  	</select>
  	
  	<select id = "bbDLCnt" parameterType="String" resultType = "Dlike">
  		SELECT * FROM harang.tbl_dlike where bb_num = #{bb_num}
  	</select>
  	
  	<update id = "bbUpdateCnt" parameterType="String">
  	
		update tbl_bamboo set bb_count = bb_count+1 where bb_num = #{bb_num} 
  		
  	</update>  
  	
  	
  	<select id = "bbRList" parameterType="String" resultType="Bbreply">
  	
  		SELECT * FROM harang.tbl_bbreply where bb_num = #{bb_num}
  	
  	</select>
  	
  
  </mapper>